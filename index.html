<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>mySBSI - DPC Kota Bitung</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;700;900&display=swap');
        body { font-family: 'Public Sans', sans-serif; background: #f8fafc; margin: 0; overflow-x: hidden; }
        .page { display: none; min-height: 100vh; flex-direction: column; width: 100%; }
        .active { display: flex !important; }
        
        /* Splash Screen */
        #splash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #002D57; z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: opacity 0.8s ease;
        }

        /* Form Styling */
        .btn-nav { padding: 18px; border-radius: 16px; font-weight: 900; text-transform: uppercase; text-align: center; cursor: pointer; transition: 0.3s; }
        .menu-card { background: white; border-radius: 24px; padding: 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; cursor: pointer; }
        .card-input { background: white; padding: 16px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        input[type="number"]::-webkit-inner-spin-button { display: none; }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; border: none; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="splash">
        <div class="flex-1 flex flex-col items-center justify-center">
            <img src="Logo_SBSI.png" class="w-40 mb-6 animate-pulse">
        </div>
        <div class="pb-10 text-center text-white">
            <p class="font-black tracking-[0.2em] text-sm uppercase">FSBSI DPC KOTA BITUNG</p>
            <p class="text-[10px] opacity-60 mt-1 font-bold">@2026 by OD</p>
        </div>
    </div>

    <div id="page-login" class="page !bg-[#002D57] items-center justify-center p-8">
        <img src="Logo_SBSI.png" class="w-32 mb-10">
        <div class="w-full max-w-sm space-y-4">
            <input type="text" id="nik" placeholder="NIK" class="w-full p-5 rounded-2xl font-bold outline-none border-4 border-transparent focus:border-[#00AEEF]">
            <input type="password" id="pass" placeholder="Password" class="w-full p-5 rounded-2xl font-bold outline-none border-4 border-transparent focus:border-[#00AEEF]">
            <button onclick="doLogin()" id="btn-login" class="w-full p-5 bg-[#00AEEF] text-white rounded-2xl font-black shadow-xl uppercase">Masuk Sistem</button>
        </div>
    </div>

    <div id="page-dashboard" class="page">
        <div class="bg-[#002D57] p-8 pb-14 rounded-b-[40px] text-white shadow-lg">
            <div class="flex items-center gap-4">
                <img id="user-foto" src="" class="w-16 h-16 rounded-2xl border-2 border-[#00AEEF] object-cover bg-white">
                <div>
                    <h2 id="user-nama" class="font-black text-xl leading-tight uppercase">...</h2>
                    <p id="user-perusahaan" class="text-[10px] opacity-70 italic font-bold uppercase">...</p>
                </div>
            </div>
        </div>

        <div id="card-histori" class="hidden px-8 -mt-7 relative z-10">
            <div class="bg-white p-6 rounded-3xl shadow-2xl border-2 border-dashed border-[#00AEEF]">
                <p class="text-[9px] font-black text-blue-600 mb-1 uppercase tracking-widest">Estimasi Terakhir:</p>
                <h3 id="histori-total" class="text-3xl font-black text-[#002D57]">Rp 0</h3>
                <div class="flex gap-2 mt-5">
                    <button onclick="viewLast()" class="flex-1 p-3 bg-[#00AEEF] text-white rounded-xl text-[10px] font-black uppercase shadow-md">Cetak Rekap</button>
                    <button onclick="editLast()" class="flex-1 p-3 bg-slate-100 text-slate-700 rounded-xl text-[10px] font-black uppercase">Lanjut Hitung</button>
                </div>
            </div>
        </div>

        <div class="p-8 grid grid-cols-2 gap-4 mt-4">
            <div class="menu-card" onclick="startFresh()">
                <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-redo-alt text-[#00AEEF]"></i>
                </div>
                <p class="text-[10px] font-black uppercase">Hitung Baru</p>
            </div>
            <div class="menu-card" onclick="navigasi('page-hukum')">
                <div class="w-12 h-12 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-gavel text-red-500"></i>
                </div>
                <p class="text-[10px] font-black uppercase">Dasar Hukum</p>
            </div>
        </div>
        <button onclick="location.reload()" class="mx-8 p-4 bg-red-50 text-red-500 rounded-2xl font-black text-[10px] uppercase border border-red-100 shadow-sm">Logout Keluar</button>
    </div>

    <div id="page-dates" class="page">
        <div class="bg-[#002D57] p-6 text-white font-black italic shadow-md uppercase">Masa Kerja PHK</div>
        <div class="p-6 space-y-4 flex-1">
            <div class="bg-white p-6 rounded-3xl border shadow-sm">
                <label class="text-[10px] font-black text-gray-400 block mb-2 uppercase tracking-widest">Tanggal Masuk</label>
                <input type="date" id="tgl-masuk" class="w-full font-bold outline-none text-xl bg-transparent">
            </div>
            <div class="bg-white p-6 rounded-3xl border shadow-sm">
                <label class="text-[10px] font-black text-gray-400 block mb-2 uppercase tracking-widest">Tanggal PHK</label>
                <input type="date" id="tgl-phk" class="w-full font-bold outline-none text-xl bg-transparent">
            </div>
        </div>
        <div class="p-6 flex gap-3">
            <button onclick="navigasi('page-dashboard')" class="btn-nav bg-slate-200 flex-1 text-slate-600">Batal</button>
            <button onclick="initWizard()" class="btn-nav bg-[#00AEEF] text-white flex-2 w-full shadow-lg">Lanjut Input Upah</button>
        </div>
    </div>

    <div id="page-upah-tahun" class="page">
        <div id="title-upah" class="bg-[#002D57] p-6 text-white font-black italic uppercase">Input Upah</div>
        <div id="container-upah" class="flex-1 overflow-y-auto bg-slate-50"></div>
        <div class="p-4 bg-white border-t space-y-3">
            <button onclick="duplikatUpah()" class="w-full py-2 text-blue-500 font-black text-[10px] uppercase tracking-tighter">Salin Nilai Ke Semua Bulan</button>
            <div class="flex gap-2">
                <button id="btn-upah-back" class="btn-nav bg-slate-200 flex-1 text-slate-600">Kembali</button>
                <button onclick="navUpah(1)" class="btn-nav bg-[#00AEEF] text-white flex-1 shadow-md">Lanjut</button>
            </div>
        </div>
    </div>

    <div id="page-result" class="page p-6 bg-slate-100">
        <div id="print-area"></div>
        <div class="no-print mt-6 space-y-3">
            <button onclick="window.print()" class="btn-nav bg-[#00AEEF] text-white w-full shadow-xl">Cetak Dokumen Perjuangan</button>
            <button onclick="navigasi('page-dashboard')" class="btn-nav bg-white border w-full font-black text-slate-600">Ke Dashboard</button>
        </div>
    </div>

    <div id="page-hukum" class="page p-6">
        <div class="flex justify-between items-center mb-8">
            <h2 class="font-black italic text-slate-800 uppercase text-sm">Dasar Hukum</h2>
            <button onclick="navigasi('page-dashboard')" class="text-[9px] font-black bg-slate-200 px-4 py-2 rounded-full uppercase">Tutup</button>
        </div>
        <div class="space-y-4">
            <div class="bg-white p-6 rounded-3xl border-l-8 border-[#00AEEF] shadow-sm italic font-bold text-[#002D57]">
                "Upah tidak boleh lebih rendah dari upah minimum yang ditetapkan Pemerintah."
                <p class="not-italic text-[9px] text-[#00AEEF] mt-3 font-black">PP NO. 36 TAHUN 2021</p>
            </div>
            <div class="bg-white p-6 rounded-3xl border-l-8 border-red-500 shadow-sm italic font-bold text-[#002D57]">
                "Pengusaha wajib membayar uang pesangon dan/atau uang penghargaan masa kerja."
                <p class="not-italic text-[9px] text-red-500 mt-3 font-black">PASAL 40 PP NO. 35 TAHUN 2021</p>
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI ---
        const URL_GAS = "https://script.google.com/macros/s/AKfycbz3pIqlBzNAVXnK1IU-ZJ_VIUzrDkTJfJKI_X3Ux9g-y4rS2Abh52MQCtqjEEmJPIQ/exec";
        
        let DB_UMP = {}, dataUpah = {}, dataTHR = {}, years = [], curIdx = 0, userLogin = {}, lastData = null;

        // --- SPLASH SCREEN LOGIC ---
        window.addEventListener('load', () => {
            setTimeout(() => {
                const splash = document.getElementById('splash');
                splash.style.opacity = '0';
                setTimeout(() => { splash.style.display = 'none'; navigasi('page-login'); }, 800);
            }, 2500);
        });

        // --- LOGIN & DATA PERSISTENCE ---
        async function doLogin() {
            const btn = document.getElementById('btn-login'); btn.innerText = "MENYAMBUNGKAN...";
            const nik = document.getElementById('nik').value, pass = document.getElementById('pass').value;
            try {
                const res = await fetch(`${URL_GAS}?action=login&nik=${nik}&pass=${pass}`).then(r => r.json());
                if(res.status === "success") {
                    userLogin = res;
                    document.getElementById('user-nama').innerText = res.nama;
                    document.getElementById('user-foto').src = res.foto;
                    document.getElementById('user-perusahaan').innerText = res.perusahaan;
                    
                    const hist = await fetch(`${URL_GAS}?action=getLastData&nik=${nik}`).then(r => r.json());
                    if(hist.data) {
                        lastData = hist.data;
                        document.getElementById('card-histori').classList.remove('hidden');
                        document.getElementById('histori-total').innerText = "Rp " + new Intl.NumberFormat('id-ID').format(lastData.totalHak);
                    }
                    
                    const u = await fetch(`${URL_GAS}?action=getUMP`).then(r => r.json());
                    DB_UMP = u.data; 
                    navigasi('page-dashboard');
                } else alert(res.message);
            } catch(e) { alert("Gagal terhubung ke Server. Cek sinyal!"); }
            btn.innerText = "MASUK SISTEM";
        }

        function navigasi(id) { 
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
            window.scrollTo(0,0); 
        }

        function startFresh() {
            if(confirm("Semua inputan harian akan dihapus. Mulai baru?")) {
                dataUpah = {}; dataTHR = {}; 
                document.getElementById('tgl-masuk').value = "";
                document.getElementById('tgl-phk').value = "";
                navigasi('page-dates');
            }
        }

        function editLast() {
            if(!lastData) return;
            document.getElementById('tgl-masuk').value = lastData.tglMasuk.split('T')[0];
            document.getElementById('tgl-phk').value = lastData.tglPhk.split('T')[0];
            dataUpah = lastData.rawUpah;
            dataTHR = lastData.rawTHR;
            navigasi('page-dates');
        }

        function viewLast() { finalize(true); }

        // --- WIZARD LOGIC ---
        function initWizard() {
            const s = new Date(document.getElementById('tgl-masuk').value), e = new Date(document.getElementById('tgl-phk').value);
            if(isNaN(s) || isNaN(e)) return alert("Lengkapi Tanggal!");
            years = []; for(let y=s.getFullYear(); y<=e.getFullYear(); y++) years.push(y);
            curIdx = 0; renderUpahYear(); navigasi('page-upah-tahun');
        }

        function renderUpahYear() {
            const y = years[curIdx], s = new Date(document.getElementById('tgl-masuk').value), e = new Date(document.getElementById('tgl-phk').value);
            document.getElementById('title-upah').innerText = `UPAH HARIAN - TAHUN ${y}`;
            let html = "";
            
            for(let m=0; m<12; m++) {
                let firstDay = new Date(y, m, 1), lastDay = new Date(y, m + 1, 0);
                if(lastDay >= s && firstDay <= e) {
                    const k = `${y}-${m}`, val = dataUpah[k] || "";
                    
                    // PRORATA CALCULATION
                    let hariKerja = 25;
                    if (y === s.getFullYear() && m === s.getMonth()) {
                        let sisa = lastDay.getDate() - s.getDate() + 1;
                        hariKerja = Math.min(25, Math.round((sisa / lastDay.getDate()) * 25));
                    } else if (y === e.getFullYear() && m === e.getMonth()) {
                        hariKerja = Math.min(25, Math.round((e.getDate() / lastDay.getDate()) * 25));
                    }
                    let bulanan = val ? (val * hariKerja) : 0;

                    html += `
                    <div class="card-input">
                        <div>
                            <span class="font-black text-slate-700 uppercase text-xs">${firstDay.toLocaleString('id-ID',{month:'long'})}</span><br>
                            <small class="text-[9px] text-blue-500 font-bold uppercase">Est. ${hariKerja} Hari: Rp ${new Intl.NumberFormat('id-ID').format(bulanan)}</small>
                        </div>
                        <input type="number" value="${val}" placeholder="Rp" 
                            oninput="dataUpah['${k}']=this.value; renderUpahYear();" 
                            class="inp-u-val w-28 text-right font-black text-lg outline-none text-[#002D57]">
                    </div>`;
                }
            }
            document.getElementById('container-upah').innerHTML = html;
            document.getElementById('btn-upah-back').onclick = curIdx === 0 ? () => navigasi('page-dates') : () => navUpah(-1);
        }

        function navUpah(d) { curIdx += d; if(curIdx >= years.length) finalize(); else renderUpahYear(); }
        function duplikatUpah() { 
            let last = ""; document.querySelectorAll('.inp-u-val').forEach(i => { if(i.value) last = i.value; });
            if(last) {
                document.querySelectorAll('.inp-u-val').forEach(i => { if(!i.value) { i.value = last; i.dispatchEvent(new Event('input')); }});
            }
        }

        // --- FINAL CALCULATION ---
        async function finalize(viewOnly = false) {
            const sIn = document.getElementById('tgl-masuk').value, eIn = document.getElementById('tgl-phk').value;
            const s = new Date(sIn), e = new Date(eIn);
            
            let diff = e.getTime() - s.getTime();
            let totalHari = Math.floor(diff / (1000 * 60 * 60 * 24));
            let dy = Math.floor(totalHari / 365), dm = Math.floor((totalHari % 365) / 30);
            let mkText = `${dy} Tahun ${dm} Bulan`;

            // Upah Tetap Terakhir (Harian Terakhir x 25)
            let lastKey = `${e.getFullYear()}-${e.getMonth()}`;
            let upahTetap = (dataUpah[lastKey] || 0) * 25;
            
            let koefPsg = dy < 1 ? 1 : (dy >= 8 ? 9 : dy + 1);
            let koefUpmk = dy < 3 ? 0 : (dy < 6 ? 2 : (dy < 9 ? 3 : (dy < 12 ? 4 : (dy < 15 ? 5 : (dy < 18 ? 6 : (dy < 21 ? 7 : (dy < 24 ? 8 : 10)))))));
            
            let pesangon = koefPsg * upahTetap;
            let upmk = koefUpmk * upahTetap;
            let total = pesangon + upmk;

            document.getElementById('print-area').innerHTML = `
                <div style="background:#002D57; padding:40px; color:white; text-align:center; border-radius:30px 30px 0 0;">
                    <img src="Logo_SBSI.png" style="width:70px; margin-bottom:15px;">
                    <p style="font-[9px] font-black opacity-60 uppercase tracking-widest">Total Estimasi Hak</p>
                    <h1 style="font-size:36px; font-weight:900; margin:0;">Rp ${new Intl.NumberFormat('id-ID').format(total)}</h1>
                </div>
                <div style="background:white; padding:30px; border-radius:0 0 30px 30px; border:1px solid #eee;">
                    <table style="width:100%; border-collapse:collapse; font-size:12px;">
                        <tr style="border-bottom:1px solid #f1f1f1;"><td style="padding:10px 0; color:#999;">ANGGOTA</td><td style="text-align:right; font-weight:900;">${userLogin.nama}</td></tr>
                        <tr style="border-bottom:1px solid #f1f1f1;"><td style="padding:10px 0; color:#999;">PERUSAHAAN</td><td style="text-align:right; font-weight:900;">${userLogin.perusahaan}</td></tr>
                        <tr style="border-bottom:1px solid #f1f1f1;"><td style="padding:10px 0; color:#999;">MASA KERJA</td><td style="text-align:right; font-weight:900;">${mkText}</td></tr>
                    </table>
                    <div style="margin-top:20px; border-top:2px solid #002D57; padding-top:20px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><b>PESANGON</b><b>Rp ${new Intl.NumberFormat('id-ID').format(pesangon)}</b></div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><b>UPMK</b><b>Rp ${new Intl.NumberFormat('id-ID').format(upmk)}</b></div>
                    </div>
                </div>`;

            if(!viewOnly) {
                const payload = { nik: document.getElementById('nik').value, nama: userLogin.nama, tglMasuk: sIn, tglPhk: eIn, masaKerja: mkText, totalHak: total, rawUpah: dataUpah, rawTHR: dataTHR };
                fetch(`${URL_GAS}?action=saveHistori&data=${encodeURIComponent(JSON.stringify(payload))}`);
            }
            navigasi('page-result');
        }
    </script>
</body>
</html>
