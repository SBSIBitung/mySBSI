<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>mySBSI - Bitung Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <style>
        .bg-mysbsi { background-color: #003366; }
        body, html { margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden; background: #f8fafc; font-family: sans-serif; }
        .page { display: none; position: absolute; inset: 0; width: 100%; height: 100%; flex-direction: column; background: #f8fafc; z-index: 10; }
        .active { display: flex !important; z-index: 50; }
        .scrollable { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        #splash { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card-premium { background: white; border-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; }
        .btn-main { background: #003366; color: white; border-radius: 15px; font-weight: bold; transition: all 0.2s; }
        .btn-main:active { scale: 0.98; }
        @media print { .no-print { display: none !important; } .page { display: block !important; position: static; height: auto; } }
    </style>
</head>
<body>

    <div id="splash">
        <img src="Logo_SBSI.png" class="w-24 animate__animated animate__pulse animate__infinite">
        <h1 class="mt-4 text-xl font-bold text-blue-900">mySBSI BITUNG</h1>
    </div>

    <div id="page-login" class="page items-center justify-center p-6">
        <div class="card-premium p-8 w-full max-w-sm text-center">
            <img src="Logo My SBSI.png" class="w-32 mx-auto mb-6">
            <input type="text" id="nik" placeholder="NIK" class="w-full p-4 mb-3 border rounded-xl outline-none bg-gray-50">
            <input type="password" id="pass" placeholder="Password" class="w-full p-4 mb-6 border rounded-xl outline-none bg-gray-50">
            <button onclick="prosesLogin()" id="btn-login" class="w-full btn-main p-4 uppercase tracking-wider">Masuk</button>
        </div>
    </div>

    <div id="page-dashboard" class="page">
        <nav class="bg-mysbsi p-5 text-white flex justify-between items-center shadow-lg">
            <span class="font-bold text-sm tracking-tighter italic">VIVA BURUH!</span>
            <button onclick="logout()" class="text-[10px] bg-red-600 px-4 py-1.5 rounded-full font-bold uppercase">Logout</button>
        </nav>
        <div class="p-6">
            <div class="card-premium p-6 border-l-[8px] border-orange-500 mb-6">
                <h3 id="user-nama" class="font-black text-blue-900 text-lg">-</h3>
                <p id="user-perusahaan" class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mt-1">-</p>
            </div>
            <button onclick="navigasi('page-wiz-1')" class="w-full card-premium p-8 flex flex-col items-center gap-3">
                <span class="text-4xl">üßÆ</span>
                <span class="font-bold text-blue-900 uppercase text-xs">Mulai Hitung Hak PHK</span>
            </button>
        </div>
    </div>

    <div id="page-wiz-1" class="page">
        <nav class="bg-mysbsi p-5 text-white flex items-center shadow-md">
            <button onclick="navigasi('page-dashboard')" class="mr-4">‚Üê</button>
            <span class="font-bold text-sm uppercase">Masa Kerja</span>
        </nav>
        <div class="p-6 space-y-4">
            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-2">Tanggal Masuk</label>
            <input type="date" id="tgl-masuk" class="w-full p-4 card-premium outline-none">
            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-2">Tanggal PHK</label>
            <input type="date" id="tgl-phk" class="w-full p-4 card-premium outline-none">
            <button onclick="lanjutKeUpah()" class="w-full btn-main p-5 mt-4 bg-orange-500 shadow-lg">LANJUT</button>
        </div>
    </div>

    <div id="page-wiz-2" class="page">
        <nav class="bg-mysbsi p-5 text-white flex items-center shadow-md">
            <button onclick="navigasi('page-wiz-1')" class="mr-4">‚Üê</button>
            <span id="label-tahun-jalan" class="font-bold text-sm uppercase">-</span>
        </nav>
        <div class="scrollable p-4 space-y-3">
            <div class="space-y-2" id="container-input-bulan"></div>
            
            <hr class="my-4 border-dashed">
            
            <div class="p-2">
                <label class="text-[10px] font-black text-blue-900 uppercase italic">Tunjangan & Kompensasi Thn <span class="thn-label"></span></label>
                <div class="mt-2 space-y-3">
                    <div class="card-premium p-4 flex items-center justify-between border-blue-100 bg-blue-50/30">
                        <span class="text-[10px] font-bold text-gray-500 uppercase">THR Diterima</span>
                        <input type="text" id="thr-tahunan" oninput="handleCurrency(event)" placeholder="Rp 0" class="w-36 text-right font-bold text-blue-900 outline-none bg-transparent">
                    </div>
                    <div class="card-premium p-4 flex items-center justify-between border-green-100 bg-green-50/30">
                        <span class="text-[10px] font-bold text-gray-500 uppercase">Kompensasi Diterima</span>
                        <input type="text" id="komp-tahunan" oninput="handleCurrency(event)" placeholder="Rp 0" class="w-36 text-right font-bold text-green-700 outline-none bg-transparent">
                    </div>
                </div>
            </div>
        </div>
        <div class="p-4 bg-white border-t space-y-2">
            <button onclick="duplikatGajiPintar()" class="w-full bg-blue-100 text-blue-900 p-3 rounded-xl font-bold text-[10px] uppercase">Duplikat Gaji Terakhir</button>
            <button onclick="prosesTahunBerikutnya()" id="btn-next-tahun" class="w-full btn-main p-4 shadow-xl">Simpan & Lanjut</button>
        </div>
    </div>

    <div id="page-wiz-3" class="page">
        <nav class="bg-mysbsi p-5 text-white flex items-center">
            <button onclick="navigasi('page-wiz-2')" class="mr-4">‚Üê</button>
            <span class="font-bold text-sm uppercase">Patokan UMP PHK</span>
        </nav>
        <div class="p-8 text-center">
            <div class="text-5xl mb-4">üè¢</div>
            <h4 class="font-bold text-blue-900 uppercase text-sm mb-6">Input UMP Bitung / Sulut <br>Tahun <span id="thn-phk-label"></span></h4>
            <input type="text" id="ump-terakhir" oninput="handleCurrency(event)" placeholder="Rp 0" class="w-full p-5 card-premium text-center text-2xl font-black text-blue-900 outline-none border-2 border-orange-300">
            <p class="text-[9px] text-gray-400 mt-4 italic">UMP ini dasar hitung Pesangon & UMPK sesuai aturan.</p>
        </div>
        <div class="p-4 bg-white border-t mt-auto">
            <button onclick="hitungHasilFinal()" class="w-full btn-main p-5 bg-green-600 shadow-xl shadow-green-900/20">Lihat Hasil Akhir</button>
        </div>
    </div>

    <div id="page-hasil" class="page">
        <nav class="bg-mysbsi p-5 text-white flex justify-between items-center no-print">
            <button onclick="navigasi('page-dashboard')" class="text-xl">‚Üê</button>
            <span class="font-bold text-sm uppercase italic">Rekapitulasi Hak</span>
            <button onclick="logout()" class="text-xs bg-red-600 px-3 py-1 rounded-full font-bold">LOGOUT</button>
        </nav>
        
        <div class="scrollable p-6 space-y-6">
            <div class="card-premium p-6 text-center bg-gradient-to-br from-blue-900 to-blue-800 text-white shadow-2xl">
                <h4 class="text-[10px] font-bold opacity-60 uppercase tracking-widest">Total Hak Anda</h4>
                <p id="res-total" class="text-4xl font-black mt-2 text-orange-400">Rp 0</p>
            </div>

            <div class="space-y-3">
                <div class="card-premium p-4 flex justify-between items-center border-l-8 border-blue-900">
                    <span class="text-[10px] font-bold text-gray-400 uppercase">Pesangon & UMPK</span>
                    <span id="res-pesangon" class="font-black text-blue-900 text-sm">Rp 0</span>
                </div>
                <div class="card-premium p-4 flex justify-between items-center border-l-8 border-orange-500">
                    <span class="text-[10px] font-bold text-gray-400 uppercase">Selisih THR & Gaji</span>
                    <span id="res-selisih" class="font-black text-orange-700 text-sm">Rp 0</span>
                </div>
            </div>

            <div class="no-print space-y-3 pt-4">
                <button onclick="window.print()" class="w-full bg-blue-100 text-blue-900 p-4 rounded-xl font-black uppercase text-[10px] tracking-widest border border-blue-200">Cetak Laporan</button>
                <button onclick="navigasi('page-dashboard')" class="w-full bg-gray-100 text-gray-500 p-4 rounded-xl font-bold uppercase text-[10px]">Kembali ke Dashboard</button>
            </div>
        </div>
    </div>

    <script>
        /**************************************************************
         * TANDA: MASUKKAN URL WEB APP (GAS) BAPAK DI SINI
         **************************************************************/
        const URL_GAS = "https://script.google.com/macros/s/AKfycbxC8-ak4mSC-Qm8UCb2c5RHs3LjHS5xHbhccquuWc5b6ybHUdX-A8M9-Of13ajOb_Om/exec"; 
        /**************************************************************/

        let tahunList = [], indexTahunSekarang = 0, databaseUpah = {}, tglMasuk, tglPhk;
        let dataTunjangan = {}; // Menyimpan THR & Komp per tahun

        function navigasi(pageId) {
            document.querySelectorAll('.page').forEach(p => { p.classList.remove('active'); p.style.display = 'none'; });
            const target = document.getElementById(pageId);
            target.style.display = 'flex';
            setTimeout(() => target.classList.add('active'), 10);
        }

        function formatIDR(angka) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
        }

        function handleCurrency(e) {
            let val = e.target.value.replace(/[^0-9]/g, '');
            e.target.value = val ? formatIDR(val).replace("IDR", "Rp") : "";
        }

        window.addEventListener('load', () => {
            setTimeout(() => { 
                document.getElementById('splash').style.display='none'; 
                const session = localStorage.getItem("session_sbsi");
                if(session) renderUser(JSON.parse(session)); else navigasi('page-login');
            }, 2000);
        });

        async function prosesLogin() {
            const nik = document.getElementById('nik').value;
            const pass = document.getElementById('pass').value;
            if(!nik || !pass) return alert("Lengkapi data!");
            document.getElementById('btn-login').innerText = "PROSES...";
            try {
                const res = await fetch(`${URL_GAS}?action=login&nik=${nik}&pass=${pass}`);
                const data = await res.json();
                if(data.status === "success") { 
                    localStorage.setItem("session_sbsi", JSON.stringify(data.user)); 
                    renderUser(data.user); 
                } else { alert(data.message); document.getElementById('btn-login').innerText = "MASUK"; }
            } catch (e) { alert("Cek URL GAS Bapak!"); document.getElementById('btn-login').innerText = "MASUK"; }
        }

        function renderUser(user) {
            document.getElementById('user-nama').innerText = user.nama;
            document.getElementById('user-perusahaan').innerText = user.perusahaan;
            navigasi('page-dashboard');
        }

        function logout() { localStorage.removeItem("session_sbsi"); location.reload(); }

        function lanjutKeUpah() {
            const m = document.getElementById('tgl-masuk').value;
            const p = document.getElementById('tgl-phk').value;
            if(!m || !p) return alert("Pilih tanggal!");
            tglMasuk = new Date(m); tglPhk = new Date(p);
            tahunList = [];
            for(let t = tglMasuk.getFullYear(); t <= tglPhk.getFullYear(); t++) tahunList.push(t);
            indexTahunSekarang = 0;
            renderFormTahun();
        }

        function renderFormTahun() {
            const thn = tahunList[indexTahunSekarang];
            document.getElementById('label-tahun-jalan').innerText = "RIWAYAT TAHUN " + thn;
            document.querySelectorAll('.thn-label').forEach(el => el.innerText = thn);
            
            // Reset input THR/Komp jika pindah tahun
            document.getElementById('thr-tahunan').value = dataTunjangan[thn]?.thr ? formatIDR(dataTunjangan[thn].thr).replace("IDR", "Rp") : "";
            document.getElementById('komp-tahunan').value = dataTunjangan[thn]?.komp ? formatIDR(dataTunjangan[thn].komp).replace("IDR", "Rp") : "";

            const blnNama = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
            let html = "";
            let mStart = (thn === tglMasuk.getFullYear()) ? tglMasuk.getMonth() : 0;
            let mEnd = (thn === tglPhk.getFullYear()) ? tglPhk.getMonth() : 11;

            for(let i = mStart; i <= mEnd; i++) {
                const key = `${thn}-${i+1}`;
                const val = databaseUpah[key] || "";
                html += `
                <div class="card-premium p-4 flex items-center justify-between">
                    <span class="text-[10px] font-bold text-gray-400 uppercase">${blnNama[i]}</span>
                    <input type="text" id="inp-${i+1}" value="${val ? formatIDR(val).replace("IDR","Rp") : ''}" 
                           oninput="saveUpah(event, ${i+1})" placeholder="Rp 0" class="w-36 text-right font-black text-blue-900 outline-none bg-transparent">
                </div>`;
            }
            document.getElementById('container-input-bulan').innerHTML = html;
            document.getElementById('btn-next-tahun').innerText = (indexTahunSekarang === tahunList.length - 1) ? "SELESAI INPUT DATA" : "SIMPAN & LANJUT";
            navigasi('page-wiz-2');
        }

        function saveUpah(e, bln) {
            handleCurrency(e);
            databaseUpah[`${tahunList[indexTahunSekarang]}-${bln}`] = e.target.value.replace(/[^0-9]/g, '');
        }

        function duplikatGajiPintar() {
            const thn = tahunList[indexTahunSekarang];
            let lastVal = "";
            for(let i=1; i<=12; i++) { if(databaseUpah[`${thn}-${i}`]) lastVal = databaseUpah[`${thn}-${i}`]; }
            if(!lastVal) return alert("Isi gaji dulu!");
            let mEnd = (thn === tglPhk.getFullYear()) ? tglPhk.getMonth() : 11;
            for(let i=1; i<=mEnd+1; i++) {
                databaseUpah[`${thn}-${i}`] = lastVal;
                const el = document.getElementById('inp-'+i);
                if(el) el.value = formatIDR(lastVal).replace("IDR", "Rp");
            }
        }

        function prosesTahunBerikutnya() {
            const thn = tahunList[indexTahunSekarang];
            dataTunjangan[thn] = {
                thr: document.getElementById('thr-tahunan').value.replace(/[^0-9]/g, ''),
                komp: document.getElementById('komp-tahunan').value.replace(/[^0-9]/g, '')
            };
            if(indexTahunSekarang < tahunList.length - 1) { indexTahunSekarang++; renderFormTahun(); }
            else { 
                document.getElementById('thn-phk-label').innerText = tglPhk.getFullYear();
                navigasi('page-wiz-3'); 
            }
        }

        function hitungHasilFinal() {
            const ump = document.getElementById('ump-terakhir').value.replace(/[^0-9]/g, '');
            if(!ump) return alert("Isi UMP!");
            
            // Logic Hitung (Contoh)
            const pesangon = parseInt(ump) * 9; 
            const selisih = 5000000;
            
            document.getElementById('res-pesangon').innerText = formatIDR(pesangon).replace("IDR", "Rp");
            document.getElementById('res-selisih').innerText = formatIDR(selisih).replace("IDR", "Rp");
            document.getElementById('res-total').innerText = formatIDR(pesangon + selisih).replace("IDR", "Rp");
            navigasi('page-hasil');
        }
    </script>
</body>
</html>
