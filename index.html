<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>mySBSI - Federasi SBSI Kota Bitung</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <style>
        .bg-mysbsi { background-color: #003366; }
        body, html { margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden; background: #f3f4f6; }
        /* Perbaikan: Halaman benar-benar tertutup jika tidak aktif */
        .page { display: none; position: absolute; inset: 0; width: 100%; height: 100%; flex-direction: column; background: #f3f4f6; z-index: 10; }
        .active { display: flex; z-index: 50; }
        .scrollable { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        #splash { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="font-sans">

    <div id="splash">
        <img src="Logo_SBSI.png" class="w-32 animate__animated animate__zoomIn">
        <h1 class="mt-4 text-2xl font-bold text-blue-900 animate__animated animate__fadeInUp tracking-tighter">SBSI KOTA BITUNG</h1>
    </div>

    <div id="page-login" class="page items-center justify-center p-6">
        <img src="Logo My SBSI.png" class="w-48 mb-8">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md">
            <div id="slider-iklan" class="mb-6 rounded-xl overflow-hidden border bg-gray-50 h-40 flex items-center justify-center text-center p-2">
                <p class="text-gray-400 text-xs italic">Memuat info terbaru...</p>
            </div>
            <input type="text" id="nik" placeholder="NIK Pekerja" class="w-full p-4 mb-4 border rounded-2xl outline-none focus:ring-2 focus:ring-blue-900 text-sm">
            <input type="password" id="pass" placeholder="Password" class="w-full p-4 mb-6 border rounded-2xl outline-none focus:ring-2 focus:ring-blue-900 text-sm">
            <button onclick="prosesLogin()" id="btn-login" class="w-full bg-mysbsi text-white p-4 rounded-2xl font-bold shadow-lg">MASUK</button>
        </div>
    </div>

    <div id="page-dashboard" class="page">
        <nav class="bg-mysbsi p-4 text-white flex justify-between items-center shadow-lg">
            <span class="font-bold">mySBSI Mobile</span>
            <button onclick="logout()" class="bg-red-600 px-4 py-1 rounded-xl text-xs font-bold uppercase">Logout</button>
        </nav>
        <div class="scrollable p-6">
            <div class="bg-white p-6 rounded-3xl shadow-sm flex items-center mb-6 border-l-8 border-orange-500 animate__animated animate__fadeInLeft">
                <img id="user-foto" src="https://via.placeholder.com/150" class="w-16 h-16 rounded-full mr-4 border shadow-inner">
                <div>
                    <h3 id="user-nama" class="font-bold text-blue-900 text-lg leading-none">-</h3>
                    <p id="user-perusahaan" class="text-gray-500 text-sm mt-1">-</p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div onclick="navigasi('page-wiz-1')" class="bg-white p-6 rounded-3xl shadow-md text-center border active:scale-95 transition cursor-pointer">
                    <span class="text-4xl">üßÆ</span>
                    <p class="font-bold text-[10px] mt-2 text-blue-900 uppercase">Hitung Hak PHK</p>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-md text-center border active:scale-95 transition cursor-pointer">
                    <span class="text-4xl">üìö</span>
                    <p class="font-bold text-[10px] mt-2 text-blue-900 uppercase">Edukasi</p>
                </div>
            </div>
        </div>
    </div>

    <div id="page-wiz-1" class="page">
        <nav class="bg-mysbsi p-4 text-white flex items-center shadow-md">
            <button onclick="navigasi('page-dashboard')" class="mr-4 font-bold text-xl">‚Üê</button>
            <span class="font-bold text-sm">Langkah 1: Masa Kerja</span>
        </nav>
        <div class="p-6">
            <label class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Tanggal Masuk</label>
            <input type="date" id="tgl-masuk" class="w-full p-4 border rounded-2xl mb-4 mt-1 outline-none text-sm">
            <label class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Tanggal PHK</label>
            <input type="date" id="tgl-phk" class="w-full p-4 border rounded-2xl mb-8 mt-1 outline-none text-sm">
            <button onclick="lanjutKeUpah()" class="w-full bg-orange-500 text-white p-4 rounded-2xl font-bold shadow-lg uppercase">Lanjut</button>
        </div>
    </div>

    <div id="page-wiz-2" class="page">
        <nav class="bg-mysbsi p-4 text-white flex items-center shadow-md">
            <button onclick="navigasi('page-wiz-1')" class="mr-4 font-bold text-xl">‚Üê</button>
            <span id="label-tahun-jalan" class="font-bold text-sm italic">Tahun -</span>
        </nav>
        <div class="scrollable p-4 space-y-3" id="container-input-bulan"></div>
        <div class="p-4 bg-white border-t space-y-3">
            <button onclick="duplikatGajiPintar()" class="w-full bg-blue-100 text-blue-900 p-3 rounded-xl font-bold text-[10px] border border-blue-200 uppercase tracking-widest">Duplikat Gaji Terakhir</button>
            <button onclick="prosesTahunBerikutnya()" id="btn-next-tahun" class="w-full bg-orange-500 text-white p-4 rounded-2xl font-bold shadow-lg uppercase">Simpan & Lanjut</button>
        </div>
    </div>

    <script>
        const URL_GAS = "https://script.google.com/macros/s/AKfycbwraAGb4tAeOz09azXLykXK-ql2Qurx7-iX0CdWYa-NayBrlqVFj5G-ERzFUpUrqVf4/exec";

        let tahunList = [];
        let indexTahunSekarang = 0;
        let databaseUpah = {};

        function formatRupiah(angka, prefix) {
            let number_string = angka.replace(/[^,\d]/g, '').toString(),
                split = number_string.split(','),
                sisa = split[0].length % 3,
                rupiah = split[0].substr(0, sisa),
                ribuan = split[0].substr(sisa).match(/\d{3}/gi);
            if (ribuan) {
                let separator = sisa ? '.' : '';
                rupiah += separator + ribuan.join('.');
            }
            rupiah = split[1] != undefined ? rupiah + ',' + split[1] : rupiah;
            return prefix == undefined ? rupiah : (rupiah ? 'Rp ' + rupiah : '');
        }

        function handleInputRupiah(e) {
            let val = e.target.value;
            e.target.value = formatRupiah(val, 'Rp ');
            const idBulan = e.target.id.split('-')[1];
            databaseUpah[`${tahunList[indexTahunSekarang]}-${idBulan}`] = val.replace(/[^0-9]/g, '');
        }

        window.addEventListener('load', () => {
            muatIklan();
            setTimeout(() => {
                document.getElementById('splash').style.display = 'none';
                checkSession();
            }, 2000);
        });

        function navigasi(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        async function muatIklan() {
            try {
                const res = await fetch(`${URL_GAS}?action=getIklan`);
                const data = await res.json();
                if(data.length > 0) document.getElementById('slider-iklan').innerHTML = `<img src="${data[0].url}" class="w-full h-full object-cover rounded-lg shadow-sm">`;
            } catch (e) { }
        }

        async function prosesLogin() {
            const nik = document.getElementById('nik').value;
            const pass = document.getElementById('pass').value;
            const btn = document.getElementById('btn-login');
            if(!nik || !pass) return alert("Isi NIK & Password!");
            btn.innerText = "MENGHUBUNGKAN..."; btn.disabled = true;
            try {
                const res = await fetch(`${URL_GAS}?action=login&nik=${nik}&pass=${pass}`);
                const data = await res.json();
                if(data.status === "success") { localStorage.setItem("session_sbsi", JSON.stringify(data.user)); renderUser(data.user); }
                else { alert(data.message); btn.innerText = "MASUK"; btn.disabled = false; }
            } catch (e) { alert("Error Server!"); btn.innerText = "MASUK"; btn.disabled = false; }
        }

        function renderUser(user) {
            document.getElementById('user-nama').innerText = user.nama;
            document.getElementById('user-perusahaan').innerText = user.perusahaan;
            if(user.foto) document.getElementById('user-foto').src = user.foto;
            navigasi('page-dashboard');
        }

        function checkSession() {
            const session = localStorage.getItem("session_sbsi");
            if(session) renderUser(JSON.parse(session)); else navigasi('page-login');
        }

        function logout() { if(confirm("Logout?")) { localStorage.removeItem("session_sbsi"); location.reload(); } }

        function lanjutKeUpah() {
            const m = document.getElementById('tgl-masuk').value;
            const p = document.getElementById('tgl-phk').value;
            if(!m || !p) return alert("Pilih tanggal!");
            tahunList = [];
            for(let t = new Date(m).getFullYear(); t <= new Date(p).getFullYear(); t++) tahunList.push(t);
            indexTahunSekarang = 0;
            renderFormTahun();
        }

        function renderFormTahun() {
            const thn = tahunList[indexTahunSekarang];
            document.getElementById('label-tahun-jalan').innerText = "Riwayat Upah Tahun " + thn;
            const blnNama = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
            let html = "";
            blnNama.forEach((nama, i) => {
                const key = `${thn}-${i+1}`;
                const rawVal = databaseUpah[key] || "";
                const formattedVal = rawVal ? formatRupiah(rawVal, 'Rp ') : "";
                html += `
                <div class="flex items-center justify-between bg-white p-4 border rounded-2xl shadow-sm">
                    <span class="text-[10px] font-bold text-gray-400 uppercase tracking-tighter">${nama}</span>
                    <input type="text" id="inp-${i+1}" value="${formattedVal}" oninput="handleInputRupiah(event)" 
                           placeholder="Rp 0" class="w-40 text-right font-black text-blue-900 outline-none bg-transparent">
                </div>`;
            });
            document.getElementById('container-input-bulan').innerHTML = html;
            const btnNext = document.getElementById('btn-next-tahun');
            btnNext.innerText = (indexTahunSekarang === tahunList.length - 1) ? "HITUNG FINAL" : "SIMPAN & LANJUT KE " + tahunList[indexTahunSekarang+1];
            navigasi('page-wiz-2');
        }

        function duplikatGajiPintar() {
            const thn = tahunList[indexTahunSekarang];
            let gajiTerakhir = "";
            let bulanTerakhirDiisi = 0;
            for(let i = 1; i <= 12; i++) {
                const val = databaseUpah[`${thn}-${i}`];
                if(val && val > 0) { gajiTerakhir = val; bulanTerakhirDiisi = i; }
            }
            if(bulanTerakhirDiisi === 0) return alert("Isi satu bulan!");
            for(let i = bulanTerakhirDiisi + 1; i <= 12; i++) {
                databaseUpah[`${thn}-${i}`] = gajiTerakhir;
                document.getElementById('inp-' + i).value = formatRupiah(gajiTerakhir, 'Rp ');
            }
        }

        function prosesTahunBerikutnya() {
            const thn = tahunList[indexTahunSekarang];
            if(!databaseUpah[`${thn}-1`]) return alert("Mohon isi minimal upah Januari!");
            if(indexTahunSekarang < tahunList.length - 1) {
                indexTahunSekarang++;
                renderFormTahun();
            } else {
                alert("Data Tersimpan! Menuju Ringkasan Hasil PHK...");
                // Selanjutnya kita akan buat fungsi hitung hasil di sini
            }
        }
    </script>
</body>
</html>
