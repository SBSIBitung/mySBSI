<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>mySBSI Mobile - Federasi Bitung</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap');
        body { font-family: 'Montserrat', sans-serif; background: #f4f7fa; overflow: hidden; }
        .bg-mysbsi { background: #003366; }
        .page { display: none; position: absolute; inset: 0; flex-direction: column; background: #f4f7fa; z-index: 10; }
        .active { display: flex !important; z-index: 50; }
        .glass { background: white; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.03); }
        .scrollable { flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }
        input[type="date"], input[type="text"] { border-radius: 15px; padding: 15px; border: 1px solid #e2e8f0; outline: none; width: 100%; font-weight: 600; }
        #splash { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        @media print { .no-print { display: none !important; } .page { display: block !important; position: static; } }
    </style>
</head>
<body>

    <div id="splash">
        <img src="Logo_SBSI.png" class="w-24 animate__animated animate__pulse animate__infinite">
        <h1 class="mt-4 font-black text-blue-900 tracking-tighter">mySBSI BITUNG</h1>
    </div>

    <div id="page-login" class="page active items-center justify-center p-8 bg-gradient-to-b from-white to-blue-50">
        <div class="w-full max-w-sm text-center">
            <img src="Logo My SBSI.png" class="w-64 mx-auto mb-10 animate__animated animate__fadeInDown drop-shadow-2xl">
            <div class="glass p-8 space-y-4">
                <h2 class="text-xs font-black text-blue-900 uppercase tracking-[4px] mb-4">Akses Anggota</h2>
                <input type="text" id="nik" placeholder="NIK / No. Anggota">
                <input type="password" id="pass" placeholder="Password">
                <button onclick="prosesLogin()" id="btn-login" class="w-full bg-mysbsi text-white p-4 rounded-2xl font-black shadow-xl active:scale-95 transition-all">MASUK</button>
            </div>
        </div>
    </div>

    <div id="page-dashboard" class="page">
        <nav class="bg-mysbsi p-6 text-white flex justify-between items-center rounded-b-[40px] shadow-2xl">
            <div>
                <p class="text-[10px] font-bold opacity-60 uppercase tracking-widest leading-none">Anggota Terdaftar</p>
                <h3 id="user-nama" class="font-black text-lg">-</h3>
            </div>
            <button onclick="logout()" class="bg-red-600 p-2 rounded-xl text-[10px] font-bold uppercase">Logout</button>
        </nav>
        <div class="p-6">
            <div class="glass p-6 mb-6 border-l-[10px] border-orange-500">
                <p id="user-perusahaan" class="text-xs font-bold text-gray-500 uppercase tracking-tighter">-</p>
            </div>
            <button onclick="navigasi('page-wiz-1')" class="w-full glass p-10 flex flex-col items-center gap-4 active:bg-gray-50 transition">
                <span class="text-5xl">⚖️</span>
                <span class="font-black text-blue-900 uppercase text-xs tracking-widest">Kalkulator Hak PHK</span>
            </button>
        </div>
    </div>

    <div id="page-wiz-1" class="page">
        <nav class="p-6 flex items-center gap-4">
            <button onclick="navigasi('page-dashboard')" class="w-10 h-10 glass flex items-center justify-center font-bold">←</button>
            <h2 class="font-black text-blue-900 uppercase text-sm">Masa Kerja</h2>
        </nav>
        <div class="p-8 space-y-6">
            <div>
                <label class="text-[10px] font-black text-gray-400 uppercase ml-2 mb-2 block">Tgl Masuk</label>
                <input type="date" id="tgl-masuk">
            </div>
            <div>
                <label class="text-[10px] font-black text-gray-400 uppercase ml-2 mb-2 block">Tgl PHK</label>
                <input type="date" id="tgl-phk">
            </div>
            <button onclick="lanjutKeUpah()" class="w-full bg-orange-500 text-white p-5 rounded-2xl font-black shadow-lg uppercase">Mulai Input Riwayat</button>
        </div>
    </div>

    <div id="page-wiz-2" class="page">
        <nav class="p-6 bg-white flex justify-between items-center shadow-sm">
            <h2 id="label-tahun-jalan" class="font-black text-blue-900 uppercase text-sm">TAHUN -</h2>
            <button onclick="duplikatGaji()" class="text-[10px] font-bold bg-blue-100 text-blue-800 px-4 py-2 rounded-full uppercase">Duplikat Gaji</button>
        </nav>
        <div class="scrollable space-y-3" id="container-input-bulan"></div>
        <div class="p-6 bg-white border-t space-y-4 shadow-2xl">
            <div class="grid grid-cols-2 gap-4">
                <div class="p-3 bg-gray-50 rounded-2xl border">
                    <label class="text-[8px] font-black text-gray-400 uppercase block mb-1">THR Diterima</label>
                    <input type="text" id="thr-tahunan" oninput="handleCurrency(event)" placeholder="Rp 0" class="w-full bg-transparent font-bold text-blue-900 outline-none">
                </div>
                <div class="p-3 bg-gray-50 rounded-2xl border">
                    <label class="text-[8px] font-black text-gray-400 uppercase block mb-1">Kompensasi</label>
                    <input type="text" id="komp-tahunan" oninput="handleCurrency(event)" placeholder="Rp 0" class="w-full bg-transparent font-bold text-green-700 outline-none">
                </div>
            </div>
            <button onclick="prosesTahunBerikutnya()" id="btn-next-tahun" class="w-full bg-blue-900 text-white p-5 rounded-2xl font-black uppercase shadow-xl">Simpan & Lanjut</button>
        </div>
    </div>

    <div id="page-hasil" class="page">
        <nav class="p-6 bg-blue-900 text-white flex justify-between items-center no-print shadow-xl">
            <button onclick="navigasi('page-dashboard')" class="text-[10px] font-black border border-white/20 px-4 py-2 rounded-xl">HOME</button>
            <h2 class="font-black italic tracking-tighter uppercase">Hasil Rekap</h2>
            <button onclick="logout()" class="text-[10px] font-black bg-red-600 px-4 py-2 rounded-xl">LOGOUT</button>
        </nav>
        <div class="scrollable space-y-6">
            <div class="hidden print:block text-center border-b-4 border-blue-900 pb-4 mb-6">
                <h1 class="text-2xl font-black">SBSI KOTA BITUNG</h1>
                <p class="text-[10px] font-bold">DOKUMEN REKAPITULASI HAK PESANGON</p>
            </div>
            <div class="glass p-8 bg-gradient-to-br from-blue-900 to-blue-800 text-white text-center shadow-2xl">
                <p class="text-[10px] font-bold opacity-60 uppercase tracking-widest mb-2">Total Estimasi Hak Anda</p>
                <h2 id="res-total" class="text-4xl font-black text-orange-400 italic">Rp 0</h2>
            </div>
            <div class="space-y-3">
                <div class="glass p-5 flex justify-between items-center border-l-8 border-blue-900">
                    <span class="text-[10px] font-black text-gray-400 uppercase">Pesangon & UMPK</span>
                    <span id="res-pesangon" class="font-black text-blue-900">Rp 0</span>
                </div>
                <div class="glass p-5 flex justify-between items-center border-l-8 border-orange-500">
                    <span class="text-[10px] font-black text-gray-400 uppercase">Selisih Gaji & THR</span>
                    <span id="res-selisih" class="font-black text-orange-700">Rp 0</span>
                </div>
                <div class="glass p-5 flex justify-between items-center border-l-8 border-green-500">
                    <span class="text-[10px] font-black text-gray-400 uppercase">Patokan UMP Tahun PHK</span>
                    <span id="res-ump" class="font-black text-green-700">Rp 0</span>
                </div>
            </div>
            <div class="no-print space-y-3 pt-6">
                <button onclick="window.print()" class="w-full p-5 bg-white border-2 border-blue-900 text-blue-900 font-black rounded-2xl uppercase text-xs">Cetak / Simpan PDF</button>
            </div>
        </div>
    </div>

    <script>
        // MASUKKAN URL GOOGLE APPS SCRIPT BAPAK DI SINI
        const URL_GAS = "https://script.google.com/macros/s/AKfycbyaQe_TSc1RYgKNvnrMoOJvZkW70fW_7oSfAkOMpGeoxHI9nyc3tonIzj3AruDXtYep/exec"; 

        let tahunList = [], indexTahunSekarang = 0, databaseUpah = {}, dataTunjangan = {}, tglMasuk, tglPhk;

        function navigasi(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function handleCurrency(e) {
            let val = e.target.value.replace(/[^0-9]/g, '');
            e.target.value = val ? "Rp " + new Intl.NumberFormat('id-ID').format(val) : "";
        }

        function formatIDR(val) { return "Rp " + new Intl.NumberFormat('id-ID').format(val); }

        window.onload = () => { setTimeout(() => { document.getElementById('splash').style.display='none'; }, 2000); };

        async function prosesLogin() {
            const nik = document.getElementById('nik').value;
            const pass = document.getElementById('pass').value;
            if(!nik || !pass) return alert("Isi NIK & Password!");
            
            const btn = document.getElementById('btn-login');
            btn.innerText = "AUTHENTICATING..."; btn.disabled = true;

            try {
                const res = await fetch(`${URL_GAS}?action=login&nik=${nik}&pass=${pass}`);
                const data = await res.json();
                if(data.status === "success") {
                    document.getElementById('user-nama').innerText = data.user.nama;
                    document.getElementById('user-perusahaan').innerText = data.user.perusahaan;
                    navigasi('page-dashboard');
                } else { alert(data.message); }
            } catch(e) { alert("Server Error. Cek URL GAS!"); }
            btn.innerText = "MASUK"; btn.disabled = false;
        }

        function logout() { location.reload(); }

        function lanjutKeUpah() {
            const m = document.getElementById('tgl-masuk').value;
            const p = document.getElementById('tgl-phk').value;
            if(!m || !p) return alert("Pilih Tanggal!");
            tglMasuk = new Date(m); tglPhk = new Date(p);
            tahunList = [];
            for(let t = tglMasuk.getFullYear(); t <= tglPhk.getFullYear(); t++) tahunList.push(t);
            indexTahunSekarang = 0;
            renderFormTahun();
        }

        function renderFormTahun() {
            const thn = tahunList[indexTahunSekarang];
            document.getElementById('label-tahun-jalan').innerText = "TAHUN " + thn;
            document.getElementById('thr-tahunan').value = dataTunjangan[thn]?.thr ? formatIDR(dataTunjangan[thn].thr) : "";
            document.getElementById('komp-tahunan').value = dataTunjangan[thn]?.komp ? formatIDR(dataTunjangan[thn].komp) : "";

            const blnNama = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
            let html = "";
            let mStart = (thn === tglMasuk.getFullYear()) ? tglMasuk.getMonth() : 0;
            let mEnd = (thn === tglPhk.getFullYear()) ? tglPhk.getMonth() : 11;

            for(let i = mStart; i <= mEnd; i++) {
                const val = databaseUpah[`${thn}-${i+1}`] || "";
                html += `
                <div class="glass p-4 flex justify-between items-center border-gray-50">
                    <span class="text-[10px] font-black text-gray-400 uppercase">${blnNama[i]}</span>
                    <input type="text" id="inp-${i+1}" value="${val ? formatIDR(val) : ''}" 
                           oninput="saveUpah(event, ${i+1})" placeholder="Rp 0" class="w-32 text-right font-black text-blue-900 outline-none bg-transparent">
                </div>`;
            }
            document.getElementById('container-input-bulan').innerHTML = html;
            document.getElementById('btn-next-tahun').innerText = (indexTahunSekarang === tahunList.length - 1) ? "LIHAT HASIL AKHIR" : "SIMPAN & LANJUT";
            navigasi('page-wiz-2');
        }

        function saveUpah(e, bln) {
            handleCurrency(e);
            databaseUpah[`${tahunList[indexTahunSekarang]}-${bln}`] = e.target.value.replace(/[^0-9]/g, '');
        }

        function duplikatGaji() {
            const thn = tahunList[indexTahunSekarang];
            let g = "";
            for(let i=1; i<=12; i++) if(databaseUpah[`${thn}-${i}`]) g = databaseUpah[`${thn}-${i}`];
            if(!g) return alert("Isi gaji dulu!");
            let mEnd = (thn === tglPhk.getFullYear()) ? tglPhk.getMonth() : 11;
            for(let i=1; i<=mEnd+1; i++) {
                databaseUpah[`${thn}-${i}`] = g;
                if(document.getElementById('inp-'+i)) document.getElementById('inp-'+i).value = formatIDR(g);
            }
        }

        async function prosesTahunBerikutnya() {
            const thn = tahunList[indexTahunSekarang];
            dataTunjangan[thn] = {
                thr: document.getElementById('thr-tahunan').value.replace(/[^0-9]/g, ''),
                komp: document.getElementById('komp-tahunan').value.replace(/[^0-9]/g, '')
            };
            if(indexTahunSekarang < tahunList.length - 1) { indexTahunSekarang++; renderFormTahun(); }
            else { hitungFinal(); }
        }

        async function hitungFinal() {
            const thnPHK = tglPhk.getFullYear();
            try {
                const res = await fetch(`${URL_GAS}?action=getUMP&tahun=${thnPHK}`);
                const data = await res.json();
                const ump = data.ump || 0;
                
                // Rumus Simulasi Pesangon (9x UMP)
                const hPesangon = ump * 9;
                const hSelisih = 5000000; // Logika selisih bisa dikembangkan lebih lanjut

                document.getElementById('res-pesangon').innerText = formatIDR(hPesangon);
                document.getElementById('res-selisih').innerText = formatIDR(hSelisih);
                document.getElementById('res-ump').innerText = formatIDR(ump);
                document.getElementById('res-total').innerText = formatIDR(hPesangon + hSelisih);
                navigasi('page-hasil');
            } catch(e) { alert("Gagal menarik data UMP!"); }
        }
    </script>
</body>
</html>
