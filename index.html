<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>mySBSI - Perjuangan Buruh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;700;900&display=swap');
        body { font-family: 'Public Sans', sans-serif; background: #002D57; margin: 0; }
        .page { display: none; min-height: 100vh; flex-direction: column; background: #F3F4F6; }
        .active { display: flex !important; }
        .logo-clean { width: 240px; height: 75px; object-fit: cover; object-position: top; }
        .card-input { background: white; padding: 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .card-input span { font-size: 10px; font-weight: 900; color: #64748b; text-transform: uppercase; }
        .card-input input { text-align: right; font-weight: 900; color: #002D57; border: none; outline: none; width: 45%; }
        .btn-action { background: #3D2B2A; color: white; padding: 18px; border-radius: 12px; width: 100%; font-weight: 900; text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="splash" class="fixed inset-0 bg-white z-[99] flex flex-col items-center justify-center">
        <img src="Logo_SBSI.png" class="w-24 mb-4">
        <p class="text-[10px] font-black text-gray-400 tracking-widest uppercase">Federasi SBSI Bitung</p>
    </div>

    <div id="page-login" class="page active !bg-[#002D57] items-center justify-center p-8">
        <img src="Logo My SBSI.png" class="logo-clean mb-12">
        <div class="w-full max-w-sm space-y-3">
            <input type="text" id="nik" placeholder="NIK Anggota" class="w-full p-4 rounded-xl font-bold outline-none">
            <input type="password" id="pass" placeholder="Password" class="w-full p-4 rounded-xl font-bold outline-none">
            <button onclick="doLogin()" id="btn-login" class="w-full p-4 bg-[#00AEEF] text-white rounded-xl font-black">MASUK</button>
        </div>
    </div>

    <div id="page-dates" class="page">
        <div class="bg-[#002D57] p-5 text-white flex items-center gap-3">
            <button onclick="location.reload()">‚Üê</button>
            <h2 class="font-black italic text-sm">MASA KERJA</h2>
        </div>
        <div class="p-6 space-y-4 flex-1">
            <div class="bg-white p-6 rounded-3xl shadow-sm">
                <label class="text-[10px] font-black text-gray-400 uppercase mb-2 block">Tanggal Masuk</label>
                <input type="date" id="tgl-masuk" class="w-full font-bold outline-none text-lg">
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm">
                <label class="text-[10px] font-black text-gray-400 uppercase mb-2 block">Tanggal PHK</label>
                <input type="date" id="tgl-phk" class="w-full font-bold outline-none text-lg">
            </div>
        </div>
        <div class="p-6"><button onclick="generateGaji()" class="btn-action">Lanjut Input Upah</button></div>
    </div>

    <div id="page-gaji" class="page">
        <div class="bg-[#002D57] p-5 text-white flex justify-between items-center">
            <h2 class="font-black italic text-sm">UPAH HARIAN</h2>
            <span class="text-[10px] font-bold opacity-60">X 25 HARI/BULAN</span>
        </div>
        <div id="list-gaji" class="flex-1 overflow-y-auto"></div>
        <div class="p-4 bg-white border-t sticky bottom-0">
            <div onclick="duplikat()" class="text-center text-blue-500 font-black text-[10px] uppercase mb-4 cursor-pointer">Duplikat Terakhir</div>
            <button onclick="navigasi('page-tambahan')" class="btn-action">Lanjut THR & Kompensasi</button>
        </div>
    </div>

    <div id="page-tambahan" class="page">
        <div class="bg-[#002D57] p-5 text-white font-black italic text-sm uppercase">THR & Kompensasi / Tahun</div>
        <div id="list-tambahan" class="flex-1 overflow-y-auto"></div>
        <div class="p-6"><button onclick="hitungFinal()" class="btn-action">Hitung Hasil Akhir</button></div>
    </div>

    <div id="page-ump" class="page items-center justify-center p-8">
        <div class="bg-white p-10 rounded-[40px] shadow-2xl w-full text-center border-t-8 border-orange-500">
            <h3 class="font-black text-[#002D57] text-sm uppercase mb-1">UMP TERAKHIR (PATOKAN)</h3>
            <p id="ump-thn" class="text-[10px] text-gray-400 font-bold mb-6">TAHUN -</p>
            <div id="ump-val" class="text-4xl font-black text-[#002D57] mb-10">Rp 0</div>
            <button onclick="alert('Cetak PDF Rekapitulasi...')" class="w-full py-5 bg-[#10B981] text-white rounded-2xl font-black uppercase">Cetak Hasil Rekap</button>
            <p onclick="navigasi('page-dates')" class="mt-6 text-[10px] font-black text-gray-400 uppercase cursor-pointer">Ulangi Input</p>
        </div>
    </div>

    <script>
        const URL_GAS = "https://script.google.com/macros/s/AKfycbxZ9gdhYqVXDhg7dPjG2OmiMAqiPm886q2IjlDR0r23RaNMIec9xrpKRAMfRZziTQa0/exec";
        let dbUmp = {};

        window.onload = () => { setTimeout(() => document.getElementById('splash').style.display='none', 2000); };

        async function doLogin() {
            const btn = document.getElementById('btn-login');
            btn.innerText = "PROSES...";
            try {
                const res = await fetch(`${URL_GAS}?action=login&nik=${document.getElementById('nik').value}&pass=${document.getElementById('pass').value}`).then(r => r.json());
                if(res.status === "success") {
                    const u = await fetch(`${URL_GAS}?action=getUMP`).then(r => r.json());
                    dbUmp = u.data;
                    navigasi('page-dates');
                } else alert(res.message);
            } catch(e) { alert("Error Server!"); }
            btn.innerText = "MASUK";
        }

        function generateGaji() {
            const start = new Date(document.getElementById('tgl-masuk').value);
            const end = new Date(document.getElementById('tgl-phk').value);
            if(isNaN(start) || isNaN(end)) return alert("Set Tanggal!");

            let hGaji = "", hTambahan = "", years = new Set();
            let curr = new Date(start.getFullYear(), start.getMonth(), 1);

            while(curr <= end) {
                const label = curr.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
                let pengali = 25;
                // Logika Prorata Bulan Pertama
                if(curr.getMonth() === start.getMonth() && curr.getFullYear() === start.getFullYear()) {
                    let sisaHari = new Date(start.getFullYear(), start.getMonth() + 1, 0).getDate() - start.getDate() + 1;
                    pengali = Math.min(25, sisaHari);
                }
                hGaji += `<div class="card-input"><div><span>${label}</span><br><small class="text-[8px] font-bold text-orange-500">${pengali} HARI KERJA</small></div><input type="text" placeholder="Rp 0" oninput="fmt(this)" class="inp-g"></div>`;
                years.add(curr.getFullYear());
                curr.setMonth(curr.getMonth() + 1);
            }

            years.forEach(y => {
                hTambahan += `<div class="p-4 bg-gray-200 text-[10px] font-black text-blue-900 uppercase">Tahun ${y}</div><div class="card-input"><span>THR</span><input type="text" placeholder="Rp 0" oninput="fmt(this)"></div><div class="card-input"><span>KOMPENSASI</span><input type="text" placeholder="Rp 0" oninput="fmt(this)"></div>`;
            });

            document.getElementById('list-gaji').innerHTML = hGaji;
            document.getElementById('list-tambahan').innerHTML = hTambahan;
            navigasi('page-gaji');
        }

        function hitungFinal() {
            const tgl = new Date(document.getElementById('tgl-phk').value);
            const thn = tgl.getFullYear();
            const val = dbUmp[thn] || 0;
            document.getElementById('ump-thn').innerText = `TAHUN ${thn}`;
            document.getElementById('ump-val').innerText = "Rp " + new Intl.NumberFormat('id-ID').format(val);
            navigasi('page-ump');
        }

        function fmt(el) {
            let v = el.value.replace(/[^0-9]/g, '');
            el.value = v ? "Rp " + new Intl.NumberFormat('id-ID').format(v) : "";
        }

        function duplikat() {
            const inps = document.querySelectorAll('.inp-g');
            let last = "";
            inps.forEach(i => { if(i.value) last = i.value; });
            if(last) inps.forEach(i => { if(!i.value) i.value = last; });
        }

        function navigasi(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>
