<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>mySBSI Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;700;900&display=swap');
        body { font-family: 'Public Sans', sans-serif; background: #f8fafc; }
        .page { display: none; min-height: 100vh; flex-direction: column; }
        .active { display: flex !important; }
        .history-card { background: white; border-radius: 24px; padding: 20px; border: 2px dashed #00AEEF; margin: 20px; }
    </style>
</head>
<body>

    <div id="page-login" class="page active !bg-[#002D57] items-center justify-center p-8">
        <button onclick="doLogin()" id="btn-login" class="w-full max-w-sm p-5 bg-[#00AEEF] text-white rounded-2xl font-black">MASUK SISTEM</button>
    </div>

    <div id="page-dashboard" class="page">
        <div class="bg-[#002D57] p-8 pb-14 rounded-b-[50px] text-white relative shadow-xl">
            <div class="flex items-center gap-5">
                <img id="user-foto" src="" class="w-20 h-20 rounded-3xl border-4 border-[#00AEEF] object-cover shadow-lg">
                <div>
                    <h2 id="user-nama" class="font-black text-2xl uppercase">...</h2>
                    <p id="user-perusahaan" class="text-xs opacity-70 italic">...</p>
                </div>
            </div>
        </div>

        <div id="last-calc-info" class="hidden">
            <div class="history-card mt-[-30px] relative z-10 shadow-xl">
                <div class="flex justify-between items-start mb-3">
                    <span class="text-[9px] font-black bg-orange-100 text-orange-600 px-3 py-1 rounded-full uppercase">Kalkulasi Terakhir</span>
                    <span id="last-date" class="text-[9px] text-gray-400 font-bold">...</span>
                </div>
                <h3 id="last-total" class="text-2xl font-black text-[#002D57]">Rp 0</h3>
                <div class="flex gap-2 mt-4">
                    <button onclick="viewLastResult()" class="flex-1 p-3 bg-[#00AEEF] text-white rounded-xl text-[10px] font-black uppercase">Cetak / Lihat</button>
                    <button onclick="editLastCalc()" class="flex-1 p-3 bg-slate-100 text-slate-700 rounded-xl text-[10px] font-black uppercase">Edit Data</button>
                </div>
            </div>
        </div>

        <div class="p-8 grid grid-cols-2 gap-4">
            <div class="bg-white p-6 rounded-3xl text-center shadow-sm border" onclick="navigasi('page-dates')">
                <i class="fas fa-plus-circle text-2xl text-[#00AEEF] mb-2"></i>
                <p class="text-[10px] font-black uppercase">Hitung Baru</p>
            </div>
            </div>
    </div>

    <script>
        const URL_GAS = "https://script.google.com/macros/s/AKfycbwnuBs25r-q2VF4E0dejTkj2i8yMjhoWxMFWMz9PdDvaF0EK1JF0zXDGx5RsDYcyct9/exec";
        let DB_UMP = {};
        let dataUpah = {}, dataTHR = {}, years = [], curIdx = 0, loggedUser = {}, lastSavedData = null;

        async function doLogin() {
            const nik = document.getElementById('nik').value;
            const pass = document.getElementById('pass').value;
            try {
                const res = await fetch(`${URL_GAS}?action=login&nik=${nik}&pass=${pass}`).then(r => r.json());
                if(res.status === "success") {
                    loggedUser = res;
                    document.getElementById('user-nama').innerText = res.nama;
                    document.getElementById('user-foto').src = res.foto;
                    document.getElementById('user-perusahaan').innerText = res.perusahaan;
                    
                    // Cek Histori
                    await checkHistory(nik);
                    
                    navigasi('page-dashboard');
                    const u = await fetch(`${URL_GAS}?action=getUMP`).then(r => r.json());
                    DB_UMP = u.data;
                } else { alert(res.message); }
            } catch(e) { alert("Error!"); }
        }

        async function checkHistory(nik) {
            const res = await fetch(`${URL_GAS}?action=getLastData&nik=${nik}`).then(r => r.json());
            if(res.status === "success" && res.data) {
                lastSavedData = res.data;
                document.getElementById('last-calc-info').classList.remove('hidden');
                document.getElementById('last-date').innerText = new Date(res.data.timestamp).toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'});
                document.getElementById('last-total').innerText = "Rp " + new Intl.NumberFormat('id-ID').format(res.data.totalHak);
            }
        }

        function editLastCalc() {
            if(!lastSavedData) return;
            // ISI OTOMATIS FORMULIR
            document.getElementById('tgl-masuk').value = lastSavedData.tglMasuk.split('T')[0];
            document.getElementById('tgl-phk').value = lastSavedData.tglPhk.split('T')[0];
            dataUpah = lastSavedData.rawUpah;
            dataTHR = lastSavedData.rawTHR;
            
            navigasi('page-dates');
            alert("Data lama berhasil dimuat. Silakan edit bagian yang diperlukan.");
        }

        function viewLastResult() {
            // Langsung ke halaman hasil menggunakan data terakhir
            finalize(true); 
        }

        async function finalize(isViewOnly = false) {
            // ... (Logika hitungan sama seperti reset basic) ...
            
            // Tambahkan raw data ke payload saat save
            if(!isViewOnly) {
                const payload = {
                    // ... data lainnya ...
                    rawUpah: dataUpah,
                    rawTHR: dataTHR
                };
                fetch(`${URL_GAS}?action=saveHistori&data=${encodeURIComponent(JSON.stringify(payload))}`);
            }
            
            // Render Result...
            navigasi('page-result');
        }

        function navigasi(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>
